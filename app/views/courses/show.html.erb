<% content_for :title do %>
  Showing Course: <%= @course.name %>
<% end %>

<div class="student_selector">
	<h4 class="student_selector_title"><a href="#" id="random_student_selector" style="color:white">Click to Select Student at Random</a></h4>

	<div class="box_content">	
		<div id="selected_student_name" class="selected_student_name_class"></div><br>
		<div id="selected_student_sid" class="selected_student_sid_class"></div><br>
		<div id="selected_student_note" class="selected_student_note_class"></div>

		<div id="buttons" style="visibility:hidden;">
		    <button type="button" id="answer" class="pure-button pure-button-active selector_button" style="background: rgb(28, 184, 65); border-radius: 4px; text-shadow: 0 1px 1px rgba(0, 0, 0, 0.2);">Answered</button>
		    <button type="button" id="pass" class="pure-button pure-button-active selector_button" style="background: rgb(202, 60, 60)">Passed</button>
		    <button type="button" id="absent" class="pure-button pure-button-active selector_button" style="background: steelblue">Absent</button>
		    <button type="button" id="note" class="pure-button pure-button-active selector_button" style="background: rgb(0, 100, 50)">Note</button>
		</div>
		<h3 style="visibility:hidden;" id="last_text"><strong>Last student selected: </strong></h3>
		<p id="last_student" style="visibility:visible;"></p>
	</div>
</div>
<div id="note_prompt" style="display:none; cursor: default">
		<h1>Please enter a student note</h1>
		<input type="text_area" id="note_left" />
		<input type="button" id="submit" value="Submit" />
		<input type="button" id="cancel" value="Cancel" />
</div>
<% student_array = Array.new %>
<% student_note_array = {} %>
<a href="#" id="toggle_student_list">Toggle Student List</a><br>
<div id= "student_list" style="float:left; display:none" class="student_selector">
    <div class="box_content">
    	<%= link_to "Download as CSV", :controller => :courses, :action => :show, :format => :csv %>
	    <table id="student_info" class="display" cellspacing="0" width="30%" text-align="center">
	        <thead>
	        <tr>
	            <th>Student Name</th>
	            <th style="color:rgb(28, 184, 65)">Answered</th>
	            <th style="color:rgb(202, 60, 60)">Passed</th>
	            <th style="color:steelblue">Absent</th>
	        </tr>
	        </thead>
	        <tbody>
	        <% @course.students.each do |student| %>
	          <tr>
	              <td><%=student.name%></td>
	              <% student_array.push({:name => student.name, :SID => student.sid, :id => student.id}) %>
	              <% student_note_array[student.id] = {:note => student.courses_student.where(:courses_id => @course.id).first.note,
	              		:id => student.courses_student.where(:courses_id => @course.id).first.id} %>
	              <td id="<%=student.name%>_answer"><%=student.courses_student.where(:courses_id => @course.id).first.answered%></td>
	              <td id="<%=student.name%>_pass"><%=student.courses_student.where(:courses_id => @course.id).first.passed%></td>
	              <td id="<%=student.name%>_absent"><%=student.courses_student.where(:courses_id => @course.id).first.absent%></td>
	          </tr>
	        <% end %>
	        </tbody>
	    </table>
	</div>    
</div>
<br style="clear:both">
<%= link_to 'Edit Roster', edit_course_path %>
<%= link_to 'User Page', user_path(@course.user_id) %>

<!-- A whole series of button shenanigans, updates as needed and such -->
<script type="text/javascript">
	var oTable = null;
	var current_student;
	var courses_student = <%= raw student_note_array.to_json %>;
	$(document).ready(function() {
		var student = null;
		var last_student;
		//Change the text for last student based on the URL parameters, slice removes ? I think
		$("#last_student").text(decodeURIComponent(window.location.search).slice(1));
		//If there isn't a last student yet, don't say last student
		if(decodeURIComponent(window.location.search).slice(1) != "")
		{
			$("#last_text").css('visibility','visible');
		}
		function initTable()
		{
			oTable = $('#student_info').DataTable({
				"paging": false,
				"scrollY": "400px",
	        	"scrollCollapse": true,
			});
		}
		initTable();
		$.ajaxSetup({
  			headers: {
    			'X-CSRF-Token': $('meta[name="csrf-token"]').attr('content')
  			}
		});
		$("#toggle_student_list").click(function(e){
			e.preventDefault();
			$("#student_list").slideToggle();
		})
		$("#random_student_selector").click(function(e){
			e.preventDefault();
			var student_list = <%= raw student_array.to_json %>;
			console.log(student_list);
			student = student_list[Math.floor(Math.random()*student_list.length)];
			current_student = student.id;
			last_student = student.name+" ("+student.SID+")";
			console.log(student);
			$("#selected_student_name").text(student.name);
			$("#selected_student_sid").text("("+student.SID+")");
			$("#selected_student_note").text("Note: " + courses_student[current_student].note);
			$("#selected_student_name").css('visibility','visible');
			$("#selected_student_sid").css('visibility','visible');
			$("#selected_student_note").css('visibility','visible');
			$("#buttons").css('visibility','visible');
		})
		$("#answer").click(function(e){
			//console.log("test")
			e.preventDefault();
			$.ajax({
	  			type: "POST",
	  			url: "<%= answer_course_path(@course.id) %>",
	  			data: {student:student},
	  			success: function(data){
	  				$("#"+data["name"]+"_answer").html(data["value"])
	  				console.log(data)
	  				location.reload()
	  				//$("#selected_student").css('visibility','hidden');
	  			},
	  			dataType: "json",
	  			async: "false"
			});
			$("#buttons").css('visibility','hidden');
			document.getElementById("selected_student").innerHTML = "<strong>Page updating, please wait</strong>";
			//If there aren't URL params yet, put in a ? and add it, else remove the existing ones and then do that
			if(window.location.search.substring(0,1) != "?")
			{
				window.location.href += "?"+(encodeURIComponent(last_student));
			}
			else
			{
				window.location.href -= window.location.search;
				window.location.href = "?"+encodeURIComponent(last_student);
			}
		})
		$("#absent").click(function(e){
			e.preventDefault();
			$.ajax({
	  			type: "POST",
	  			url: "<%= absent_course_path(@course.id) %>",
	  			data: {student:student},
	  			success: function(data){
	  				$("#"+data["name"]+"_absent").html(data["value"])
	  				console.log(data)
	  				location.reload()
	  			},
	  			dataType: "json"
			});
			$("#buttons").css('visibility','hidden');
			document.getElementById("selected_student").innerHTML = "<strong>Page updating, please wait</strong>";
			if(window.location.search.substring(0,1) != "?")
			{
				window.location.href += "?"+(encodeURIComponent(last_student));
			}
			else
			{
				window.location.href -= window.location.search;
				window.location.href = "?"+encodeURIComponent(last_student);
			}	
		})
		$("#pass").click(function(e){
			e.preventDefault();
			$.ajax({
	  			type: "POST",
	  			url: "<%= pass_course_path(@course.id) %>",
	  			data: {student:student},
	  			success: function(data){
	  				$("#"+data["name"]+"_pass").html(data["value"])
	  				console.log(data)
	  				location.reload()
	  			},
	  			dataType: "json"
			});
			$("#buttons").css('visibility','hidden');
			document.getElementById("selected_student").innerHTML = "<strong>Page updating, please wait</strong>";
			if(window.location.search.substring(0,1) != "?")
			{
				window.location.href += "?"+(encodeURIComponent(last_student));
			}
			else
			{
				window.location.href -= window.location.search;
				window.location.href = "?"+encodeURIComponent(last_student);
			}
		})
		//Figure out a way to update note w/o reload
		$("#note").click(function(e){
			$('#note_left').val(courses_student[current_student].note);
			$.blockUI({message: $('#note_prompt'), css: {width: '275px'}})
		})
		$("#submit").click(function(e){
			$.unblockUI();
			$.ajax({
	  			type: "POST",
	  			url: "/courses_students/"+courses_student[current_student].id+"/update_note.json",
	  			data: {note:$("#note_left").val()},
	  			success: function(data){
	  				$("#flash").html("<strong><p class=\"flash-notice\">"+data["status"]+"</p></strong>");
					$("#selected_student_note").text(" Note: " + data["note"]);
	  			},
	  			dataType: "json"
			});
		})
		$("#cancel").click(function(e){
			$.unblockUI();
			return false;
		});
})
	
</script>